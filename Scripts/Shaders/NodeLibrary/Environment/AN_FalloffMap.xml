<!--
================================================================================
== Antonio Neto Mari Procedural Library
== Copyright (c) 2014 Antonio Neto. All Rights Reserved.
================================================================================
== File: AN_FalloffMap.xml
== Description: Falloff effects like facing ratio, surface luminance and zdepth.
================================================================================
== Author: Antonio Neto
== Web: www.netocg.blogspot.com
== Email: netocg.fx@gmail.com
================================================================================
== Modified Date: June, 16 2014
================================================================================
== Redistribution and use in source and binary forms, with or without
== modification, are permitted provided that the following conditions are met:
==
== 1. Redistributions of source code must retain the above copyright
== notice, this list of conditions and the following disclaimer.
==
== 2. Redistributions in binary form must reproduce the above copyright
== notice, this list of conditions and the following disclaimer in the
== documentation and/or other materials provided with the distribution.
==
== 3. Neither the name of the copyright holder nor the names of its
== contributors may be used to endorse or promote products derived from
== this software without specific prior written permission.
==
== THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
== IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
== THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
== PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
== CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
== EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
== PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
== OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
== WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
== OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
== ADVISED OF HE POSSIBILITY OF SUCH DAMAGE.
================================================================================
-->

<Node>
    <ID>Falloff Map</ID>
    <DefaultName>Falloff Map</DefaultName>
    <Category>Environment/Custom/</Category>
    <Attributes>
        <!--===============================================================================================================-->
        <Attribute Name="FrontColor" PrettyName="Front Color" Group="Falloff Parameters" Type="color" Description="Defines the color of the Normals that are facing the camera">(0.0,0.0,0.0,1)</Attribute>
        <Attribute Name="SideColor" PrettyName="Side Color" Group="Falloff Parameters" Type="color" Description="Defines the color of the Normals that are look at 90ยบ in relation to the viewing angle">(1.0,1.0,1.0,1)</Attribute>
        <Attribute Name="FalloffStart" PrettyName="Falloff Start" Group="Falloff Parameters" Type="double" Description="Adjust where the falloff start. 1 it makes starts where the normals face the camera, while 0 means towards the edge." Min="0" Max="1">0</Attribute>
        <Attribute Name="FalloffEnd" PrettyName="Falloff End" Group="Falloff Parameters" Type="double" Description="Adjust where the falloff end. 1 it makes starts where the normals face the camera, while 0 means towards the edge." Min="0" Max="1">1</Attribute>
        <Attribute Name="FalloffType" PrettyName="Falloff Type" Group="Falloff Parameters" Type="userenum" Description="Chooses the kind of falloff. This are based on 3DS Max Falloff Map node.">0, 0,1, Facing Ratio, Shadow/Light</Attribute>
        <!--===============================================================================================================-->
    </Attributes>
    <Tags>
        <Tag>_notcacheable</Tag>
        <Tag>_notbakeable</Tag>
    </Tags>
    <Contexts>
        <Context Type='NodeGraphView'>
        </Context>
            <Context Type='GLSL'>
            <Shader ShaderType='Fragment'>
                <Body>
                <![CDATA[

                vec4 Blend  = vec4 (0.0);

                // Facing Ratio Mode
                if ($FalloffType == 0)
                {
                    float VdotN = dot(State.ViewVectorInEyeSpaceFromProjectionCamera, State.NormalInEyeSpaceFromProjectionCamera);
                    float Fresnel = clamp((abs(VdotN) - $FalloffStart) / ($FalloffEnd - $FalloffStart), 0.0, 1.0);
                    Blend  = mix($FrontColor, $SideColor, 1-Fresnel);
                    if ($FalloffStart > 0.5)
                    {
                        Blend = ($FalloffStart == $FalloffEnd) ? $SideColor : mix($FrontColor, $SideColor, 1-Fresnel);
                    }
                    if ($FalloffStart < 0.5)
                    {
                        Blend = ($FalloffStart == $FalloffEnd) ? $FrontColor : mix($FrontColor, $SideColor, 1-Fresnel);
                    }
                }

                // Shadow/Light Mode
                if ($FalloffType == 1)
                {
                    #if defined MRI_SHADER_FRAGMENT || defined MRI_SHADER_TESS_EVALUATION

                    int numLights = 0;
                    for(int i=0;i<4;i++)
                    {
                        float lightVisibility = mriLightVisibility( i, State.Position);
                        if (lightVisibility == 1)
                        {
                            numLights += 1;
                        }
                        vec3 L = normalize(u_MriLightSources[i].Position.xyz - State.FragmentPositionInEyeSpaceFromProjectionCamera);
                        float NdotL = dot(State.Normal, L);
                        float Fresnel = clamp((abs(NdotL*lightVisibility) - $FalloffStart) / ($FalloffEnd - $FalloffStart), 0.0, 1.0);
                        Blend += mix($FrontColor, $SideColor, 1-Fresnel);
                    }
                    Blend /= numLights;

                    #endif
                }

                Output = Blend;

                ]]>
                </Body>
            </Shader>
        </Context>
    </Contexts>
</Node>


